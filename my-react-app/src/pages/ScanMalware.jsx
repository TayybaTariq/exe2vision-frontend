import { useState, useRef } from "react";
import { Upload, Info, CheckCircle, AlertCircle, Play } from "lucide-react";
import HeaderLogin from '../components/HeaderAfterLogin';
import { useNavigate } from "react-router-dom";

const MalwareScanner = () => {
    const [file, setFile] = useState(null);
    const [error, setError] = useState("");
    const fileInputRef = useRef();
    const navigate = useNavigate();

    const handleFileChange = (e) => {
        if (e.target.files.length > 0) {
            const selectedFile = e.target.files[0];
            if (selectedFile.name.toLowerCase().endsWith(".exe")) {
                setFile(selectedFile);
                setError("");
            } else {
                setError("Only 64-bit Windows Executable (.exe) files are allowed.");
                setFile(null);
            }
        }
    };

    const handleDrop = (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length > 0) {
            const selectedFile = e.dataTransfer.files[0];
            if (selectedFile.name.toLowerCase().endsWith(".exe")) {
                setFile(selectedFile);
                setError("");
            } else {
                setError("Only 64-bit Windows Executable (.exe) files are allowed.");
                setFile(null);
            }
        }
    };

    const handleDragOver = (e) => {
        e.preventDefault();
    };

    const handleBrowseClick = () => {
        fileInputRef.current.click();
    };

    const handleScan = () => {
        if (!file) return;

        // Navigate to the Progress Page and send file name to it
        navigate("/progress", {
            state: { fileName: file.name }
        });
    };
    return (
        <div className="flex flex-col items-center pt-24 px-4 md:px-6 lg:px-10 min-h-screen bg-[#0A1324]">

            <h1 className="text-white text-3xl md:text-4xl font-semibold mb-4 text-center">
                Malware Detection Scanner
            </h1>

            <p className="text-gray-400 text-base md:text-lg mb-12 text-center max-w-3xl">
                Upload an executable file to analyze it for potential malware threats using our AI-powered system
            </p>

            {/* Upload Box */}
            <div
                className="w-full max-w-4xl border-2 border-dashed border-gray-600 rounded-2xl flex flex-col items-center justify-center p-10 md:p-14 mb-6 hover:border-[#14C9E7] transition bg-[#111C33] min-h-[300px]"
                onDrop={handleDrop}
                onDragOver={handleDragOver}
            >
                <Upload className="text-[#14C9E7] mb-6" size={50} />

                {!file && (
                    <p className="text-gray-400 mb-4 text-lg md:text-xl text-center">
                        Drag and drop your .exe file here
                    </p>
                )}

                {file && (
                    <p className="text-[#14C9E7] mb-4 text-lg md:text-xl text-center break-all">
                        Selected file: {file.name}
                    </p>
                )}

                <p className="text-gray-500 mb-4 text-center">or</p>

                {/* Browse Button */}
                <button
                    type="button"
                    onClick={handleBrowseClick}
                    className="bg-[#14C9E7] hover:bg-[#11b5d1] text-white font-medium py-3 px-8 rounded-xl text-lg md:text-lg mb-3 transition"
                >
                    Browse Files
                </button>

                {/* Supported format line */}
                <p className="text-[#14C9E7] font-semibold mt-3 text-sm md:text-base text-center border-t border-[#14C9E7] pt-2 w-full">
                    Supported format: 64-bit Windows Executable (.exe)
                </p>

                <input
                    type="file"
                    accept=".exe"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                />

                {error && (
                    <div className="flex items-center mt-4 text-red-500 text-sm md:text-base">
                        <AlertCircle size={18} className="mr-2" />
                        {error}
                    </div>
                )}
            </div>

            {/* Scan File Button */}
            <button
                disabled={!file}
                onClick={handleScan}
                className={`w-full max-w-4xl flex items-center justify-center gap-2 text-white font-semibold py-4 rounded-xl transition ${file ? "bg-[#14C9E7] hover:bg-[#11b5d1] cursor-pointer" : "bg-gray-600 cursor-not-allowed"
                    } mb-12 `}
            >
                <Play size={20} />
                Scan File
            </button>

            {/* Instructions + Security Div */}
            <div className="w-full max-w-4xl bg-[#111C33] rounded-2xl p-8 md:p-12 shadow-lg text-gray-300 space-y-10">

                {/* How to Scan */}
                <div>
                    <div className="flex items-center mb-6">
                        <Info className="text-[#14C9E7] mr-3" size={24} />
                        <h3 className="text-white font-semibold text-lg md:text-xl">
                            How to Scan Your File
                        </h3>
                    </div>

                    <ol className="space-y-6">
                        {[
                            {
                                title: "Select Your File",
                                desc: "Choose an executable (.exe) file from your computer. You can drag and drop it into the upload area or use the 'Browse Files' button."
                            },
                            {
                                title: "Start the Scan",
                                desc: "Once you've selected a valid .exe file, click the 'Scan File' button to begin the analysis process."
                            },
                            {
                                title: "AI Analysis",
                                desc: "Our system will disassemble the executable, extract n-gram patterns, convert them to RGB images, and run them through our deep learning model."
                            },
                            {
                                title: "View Results",
                                desc: "After 20-30 seconds, you'll receive a detailed scan report showing if the file is malicious or benign, with a confidence score and PDF download option."
                            }
                        ].map((step, idx) => (
                            <li key={idx} className="flex items-start space-x-4">
                                <div className="shrink-0 w-10 h-10 md:w-12 md:h-12 bg-[#14C9E7] text-white font-semibold rounded-full flex items-center justify-center">
                                    {idx + 1}
                                </div>
                                <div>
                                    <h4 className="text-white font-semibold text-sm md:text-base">
                                        {step.title}
                                    </h4>
                                    <p className="text-gray-300 text-sm md:text-base">
                                        {step.desc}
                                    </p>
                                </div>
                            </li>
                        ))}
                    </ol>
                </div>

                {/* Security & Privacy */}
                <div className="bg-[#0D101F] rounded-xl p-6 shadow-inner">
                    <div className="flex items-start space-x-4">
                        <CheckCircle className="text-[#14C9E7] mt-1" size={28} />
                        <div>
                            <h4 className="text-white font-semibold mb-2 text-lg md:text-xl">
                                Security & Privacy
                            </h4>
                            <p className="text-gray-300 text-sm md:text-base">
                                All uploaded files are analyzed in a secure, isolated environment and are not stored permanently on our servers.
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
};

export default function ScanMalwareComponent() {
    return (
        <div className="min-h-screen bg-gray-900 text-white font-sans overflow-x-hidden">
            <HeaderLogin />
            <MalwareScanner />
        </div>
    );
}
